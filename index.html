<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Educator + 3CS Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; }
        .chat-bubble { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing-indicator { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }

        /* Range slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-track {
            background: #1e293b;
            height: 0.5rem;
            border-radius: 0.5rem;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background: #10b981;
            border: 3px solid #0f172a;
            cursor: pointer;
            margin-top: -0.5rem;
        }

        /* Two-column layout */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            height: 100vh;
            padding: 1rem;
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
                height: auto;
            }
        }

        .chat-panel {
            display: flex;
            flex-direction: column;
            background: #1e293b;
            border-radius: 0.5rem;
            border: 1px solid #334155;
            overflow: hidden;
        }

        .content-panel {
            display: flex;
            flex-direction: column;
            background: #0f172a;
            overflow-y: auto;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            space-y: 1rem;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid #334155;
            display: flex;
            gap: 0.5rem;
        }

        .chat-input-area input {
            flex: 1;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-50">
    <div class="main-container">
        <!-- PERSISTENT CHAT (Left side) -->
        <div class="chat-panel">
            <div class="p-4 border-b border-slate-700">
                <p class="text-xs font-mono text-slate-500 mb-2">CHAT</p>
                <h2 class="text-lg font-bold">Let's talk</h2>
                <p class="text-xs text-slate-400 mt-1" id="exchange-count">0 exchanges</p>
            </div>

            <div id="chat-messages" class="chat-messages" role="log" aria-live="polite">
                <div class="chat-bubble flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex-shrink-0 flex items-center justify-center text-xs font-semibold">AI</div>
                    <div class="bg-slate-700 rounded-lg p-3 max-w-[80%]">
                        <p class="text-sm">Hey! I'm here to help you figure out if this is a fit.</p>
                        <p class="text-sm mt-2">This is a live-in builder role in West Michigan. You'd work 10-60 hrs/month on real projects—AI tools, coordination software, food systems.</p>
                        <p class="text-sm mt-2 text-slate-400">What are you curious about?</p>
                    </div>
                </div>
            </div>

            <div class="chat-input-area">
                <input type="text" id="chat-input" data-testid="chat-input" placeholder="Ask anything..."
                    class="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                <button onclick="sendMessage()" id="send-btn" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg text-sm font-semibold">Send</button>
            </div>

            <!-- Fit Score Display (for visual feedback) -->
            <div class="p-3 border-t border-slate-700 bg-slate-900">
                <div class="flex justify-between items-center text-xs">
                    <span class="text-slate-500">Fit Score</span>
                    <div id="fit-score-display" class="flex items-center gap-2">
                        <span id="fit-score-value" class="text-slate-400">—</span>
                        <div id="fit-score-bar" class="h-2 w-24 bg-slate-700 rounded-full overflow-hidden">
                            <div id="fit-score-fill" class="h-full bg-emerald-500 transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DYNAMIC CONTENT (Right side) -->
        <div class="content-panel">
            <!-- Stage: Initial (prompt to start chat) -->
            <div id="stage-initial" class="p-8 text-center max-w-2xl mx-auto">
                <div class="mb-8">
                    <p class="text-xs font-mono text-slate-500 mb-2">START HERE</p>
                    <h1 class="text-3xl font-bold mb-4">Educator + 3CS Builder</h1>
                    <p class="text-slate-400 mb-8">Live-in role. Real work. Genuine conversation.</p>
                    <button onclick="focusChat()" class="bg-emerald-500 hover:bg-emerald-400 px-6 py-3 rounded-lg text-sm font-semibold">
                        Start the conversation →
                    </button>
                </div>
            </div>

            <!-- Stage: Projects (unlocks after ~15 exchanges) -->
            <div id="stage-projects" class="hidden p-8">
                <div class="text-center mb-8">
                    <p class="text-xs font-mono text-slate-500 mb-2">STAGE 1</p>
                    <h2 class="text-2xl font-bold">What interests you?</h2>
                    <p class="text-slate-400 text-sm mt-2">Based on our chat, here's what I think might fit...</p>
                </div>

                <div id="projects-container" class="space-y-4 mb-8">
                    <!-- Projects rendered here -->
                </div>

                <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 mb-6">
                    <p class="text-sm text-slate-400 mb-2">Selected projects:</p>
                    <div id="selected-projects-list" class="flex flex-wrap gap-2">
                        <span class="text-xs text-slate-500">None yet</span>
                    </div>
                </div>

                <button onclick="goToCommit()" id="to-commit-btn" class="hidden w-full bg-emerald-500 hover:bg-emerald-400 px-6 py-3 rounded-lg text-sm font-semibold">
                    Next: Your commitment →
                </button>
            </div>

            <!-- Stage: Commitment -->
            <div id="stage-commit" class="hidden p-8">
                <div class="text-center mb-8">
                    <p class="text-xs font-mono text-slate-500 mb-2">STAGE 2</p>
                    <h2 class="text-2xl font-bold">Ready to meet?</h2>
                    <p class="text-slate-400 text-sm mt-2">Schedule a paid working session</p>
                </div>

                <div class="bg-slate-900 border border-slate-700 rounded-lg p-6 mb-6 max-w-sm">
                    <label for="name-input" class="text-sm text-slate-400 mb-2 block">Your name</label>
                    <input type="text" id="name-input" placeholder="First name"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-blue-500 mb-4">

                    <label for="email-input" class="text-sm text-slate-400 mb-2 block">Email</label>
                    <input type="email" id="email-input" placeholder="you@email.com"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-blue-500 mb-4">

                    <label for="hours-input" class="text-sm text-slate-400 mb-2 block">Hours/month (10-60)</label>
                    <input type="range" id="hours-input" min="10" max="60" value="20"
                        class="w-full mb-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500">10</span>
                        <span id="hours-value" class="text-emerald-400 font-semibold">20 hrs/month</span>
                        <span class="text-slate-500">60</span>
                    </div>
                </div>

                <div class="bg-slate-800 border border-blue-500/30 rounded-lg p-4 mb-6 max-w-sm">
                    <p class="text-sm text-blue-300 font-semibold mb-1">Next steps</p>
                    <p class="text-xs text-slate-400">You'll schedule a $50/hr paid working session (2-4 hours). If we both agree, you start a trial.</p>
                </div>

                <button onclick="goToSchedule()" id="schedule-btn" class="bg-emerald-500 hover:bg-emerald-400 px-6 py-3 rounded-lg text-sm font-semibold max-w-sm">
                    Schedule interview →
                </button>
            </div>

            <!-- Stage: Schedule -->
            <div id="stage-schedule" class="hidden p-8">
                <div class="text-center mb-8">
                    <p class="text-xs font-mono text-slate-500 mb-2">STAGE 3</p>
                    <h2 class="text-2xl font-bold">Pick a time</h2>
                    <p class="text-slate-400 text-sm mt-2">$50/hr • 2-4 hours • Real work</p>
                </div>

                <div class="bg-slate-900 border border-slate-700 rounded-lg p-6 mb-6 max-w-sm">
                    <p class="text-sm text-slate-400 mb-4">Your application</p>
                    <div class="space-y-2 text-sm">
                        <p><span class="text-slate-500">Name:</span> <span id="summary-name" class="text-white">—</span></p>
                        <p><span class="text-slate-500">Projects:</span> <span id="summary-projects" class="text-white">—</span></p>
                        <p><span class="text-slate-500">Hours:</span> <span id="summary-hours" class="text-white">—</span></p>
                    </div>
                </div>

                <!-- Google Calendar embed -->
                <div class="bg-slate-900 border border-slate-700 rounded-lg overflow-hidden mb-6 max-w-sm">
                    <iframe src="https://calendar.google.com/calendar/u/0/appointments/schedules/AcZssZ09rD-oZ5R5xg89_mnm7AP0tBpNOB9zNF7euG6T7luGJMJ4RRLO8-SFSzHFb87yR_ZqjGmngEjO" width="100%" height="400" frameborder="0" style="border:0"></iframe>
                </div>
            </div>

            <!-- Stage: Confirmed -->
            <div id="stage-confirmed" class="hidden p-8 text-center">
                <div class="w-20 h-20 rounded-full bg-emerald-500/20 border-2 border-emerald-500 flex items-center justify-center text-4xl mx-auto mb-6">✓</div>
                <h2 class="text-2xl font-bold mb-2">You're scheduled</h2>
                <p class="text-slate-400">Check your email for details</p>
            </div>
        </div>
    </div>

    <!-- Calendly widget -->
    <link href="https://assets.calendly.com/assets/external/widget.css" rel="stylesheet">
    <script src="https://assets.calendly.com/assets/external/widget.js" type="text/javascript" async></script>

    <script>
        // State
        let exchanges = 0;
        let selectedProjects = [];
        let chatHistory = [];
        let userEmail = '';
        let projects = [];
        let isStreaming = false;
        let fitScore = 0;
        let canUnlockEmail = false;
        let lastMetadata = null; // Store full metadata for Playwright access
        const API_BASE = location.hostname === 'localhost' ? 'http://localhost:3000' : '';

        // Generate session ID for KV storage
        let sessionId = localStorage.getItem('sessionId');
        if (!sessionId) {
          sessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('sessionId', sessionId);
        }

        // Initialize
        async function init() {
            // Load projects
            try {
                const response = await fetch('/data/projects.json');
                projects = await response.json();
            } catch (e) {
                console.error('Failed to load projects:', e);
                projects = [];
            }

            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !isStreaming) sendMessage();
            });

            document.getElementById('hours-input').addEventListener('input', updateHours);
        }

        // Chat
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message || isStreaming) return;

            // Add user message
            addChatMessage(message, 'user');
            chatHistory.push({ role: 'user', content: message });
            input.value = '';
            exchanges++;
            updateExchangeCount();

            // Log message
            logMessage(message, 'user');

            // Show typing indicator
            const typingDiv = showTyping();
            isStreaming = true;
            input.disabled = true;
            document.getElementById('send-btn').disabled = true;

            try {
                const response = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: chatHistory, sessionId, email: userEmail })
                });

                if (!response.ok) throw new Error('API error');

                typingDiv.remove();

                // Stream response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let aiMessage = '';
                let messageDiv = null;
                let streamComplete = false;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done || streamComplete) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                streamComplete = true;
                                break;
                            }

                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.text) {
                                    aiMessage += parsed.text;
                                    if (!messageDiv) {
                                        messageDiv = addChatMessage(aiMessage, 'assistant');
                                    } else {
                                        messageDiv.querySelector('p').textContent = aiMessage;
                                    }
                                }
                                if (parsed.type === 'metadata') {
                                    // Store full metadata for Playwright access
                                    lastMetadata = {
                                        speechAct: parsed.speechAct,
                                        dialogueAct: parsed.dialogueAct,
                                        criteria: parsed.criteria,
                                        rubricScores: parsed.rubricScores,
                                        fitScore: parsed.fitScore,
                                        rationale: parsed.rationale,
                                        canUnlockEmail: parsed.canUnlockEmail
                                    };

                                    // Expose metadata in message element for Playwright
                                    if (messageDiv) {
                                        messageDiv.setAttribute('data-metadata', JSON.stringify(lastMetadata));
                                        messageDiv.setAttribute('data-role', 'assistant');
                                    }

                                    fitScore = parsed.fitScore;
                                    canUnlockEmail = parsed.canUnlockEmail;
                                    updateFitDisplay();
                                    if (canUnlockEmail) {
                                        showEmailGate();
                                    }
                                }
                            } catch (e) {
                                // Skip invalid JSON
                            }
                        }
                    }
                }

                chatHistory.push({ role: 'assistant', content: aiMessage });
                logMessage(aiMessage, 'assistant');

                // Auto-unlock projects at 15 exchanges
                if (exchanges >= 15) {
                    showStage('projects');
                }

            } catch (error) {
                console.error('API error:', error);
                typingDiv.remove();
                addChatMessage('Sorry, something went wrong. Please try again.', 'assistant');
            }

            isStreaming = false;
            input.disabled = false;
            document.getElementById('send-btn').disabled = false;
            input.focus();
        }

        function addChatMessage(text, role) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'chat-bubble flex gap-3' + (role === 'user' ? ' flex-row-reverse' : '');

            const avatar = role === 'user'
                ? '<div class="w-8 h-8 rounded-full bg-emerald-500 flex-shrink-0 flex items-center justify-center text-xs">You</div>'
                : '<div class="w-8 h-8 rounded-full bg-blue-500 flex-shrink-0 flex items-center justify-center text-xs font-semibold">AI</div>';

            const bgColor = role === 'user' ? 'bg-emerald-500/20' : 'bg-slate-700';

            div.innerHTML = `
                ${avatar}
                <div class="${bgColor} rounded-lg p-3 max-w-[75%]">
                    <p class="text-sm">${text}</p>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div;
        }

        function showTyping() {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'chat-bubble flex gap-3';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-500 flex-shrink-0 flex items-center justify-center text-xs font-semibold">AI</div>
                <div class="bg-slate-700 rounded-lg p-3">
                    <div class="flex gap-1">
                        <span class="typing-indicator">●</span>
                        <span class="typing-indicator" style="animation-delay: 0.2s;">●</span>
                        <span class="typing-indicator" style="animation-delay: 0.4s;">●</span>
                    </div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div;
        }

        function updateExchangeCount() {
            document.getElementById('exchange-count').textContent = `${exchanges} exchanges`;
        }

        function updateFitDisplay() {
            // Update fit score display
            const scoreValue = document.getElementById('fit-score-value');
            const scoreFill = document.getElementById('fit-score-fill');

            if (fitScore !== null && fitScore !== undefined) {
                scoreValue.textContent = `${fitScore}%`;
                scoreValue.className = fitScore >= 60 ? 'text-emerald-400 font-semibold' : 'text-slate-400';
                scoreFill.style.width = `${Math.min(fitScore, 100)}%`;
            } else {
                scoreValue.textContent = '—';
                scoreValue.className = 'text-slate-400';
                scoreFill.style.width = '0%';
            }
        }

        function logMessage(content, role) {
            fetch(`${API_BASE}/api/log-message`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: userEmail,
                    message: content,
                    role,
                    timestamp: new Date().toISOString(),
                    stage: getCurrentStage(),
                    projectsInterested: selectedProjects.map(p => p.id)
                })
            }).catch(e => console.error('Log error:', e));
        }

        function getCurrentStage() {
            if (document.getElementById('stage-projects').classList.contains('hidden') === false) return 'projects';
            if (document.getElementById('stage-commit').classList.contains('hidden') === false) return 'commit';
            if (document.getElementById('stage-schedule').classList.contains('hidden') === false) return 'schedule';
            return 'chat';
        }

        function focusChat() {
            document.getElementById('chat-input').focus();
        }

        // Projects
        function renderProjects() {
            const container = document.getElementById('projects-container');
            container.innerHTML = projects.map((p, i) => `
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-6 cursor-pointer hover:border-${p.color}-500/50 transition" onclick="toggleProject('${p.id}')">
                    <p class="text-${p.color}-300 text-xs font-mono mb-2">${p.name}</p>
                    <p class="text-sm text-slate-400">${p.description}</p>
                    <p class="text-xs text-slate-500 mt-2">${p.longDescription}</p>
                    <div class="mt-4">
                        <span id="project-${p.id}-status" class="text-xs text-slate-500">Click to select</span>
                    </div>
                </div>
            `).join('');
        }

        function toggleProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            const idx = selectedProjects.findIndex(p => p.id === projectId);

            if (idx >= 0) {
                selectedProjects.splice(idx, 1);
            } else {
                selectedProjects.push(project);
            }

            updateProjectsList();
            document.getElementById(`project-${projectId}-status`).textContent =
                idx >= 0 ? 'Click to select' : '✓ Selected';

            if (selectedProjects.length > 0) {
                document.getElementById('to-commit-btn').classList.remove('hidden');
            }
        }

        function updateProjectsList() {
            const list = document.getElementById('selected-projects-list');
            if (selectedProjects.length === 0) {
                list.innerHTML = '<span class="text-xs text-slate-500">None yet</span>';
            } else {
                list.innerHTML = selectedProjects.map(p =>
                    `<span class="bg-${p.color}-500/20 text-${p.color}-300 px-3 py-1 rounded-full text-xs">${p.name}</span>`
                ).join('');
            }
        }

        // Commitment
        function updateHours() {
            const value = document.getElementById('hours-input').value;
            document.getElementById('hours-value').textContent = `${value} hrs/month`;
        }

        function goToCommit() {
            showStage('commit');
        }

        async function goToSchedule() {
            const name = document.getElementById('name-input').value || 'Anonymous';
            const email = document.getElementById('email-input').value;
            const hours = document.getElementById('hours-input').value;

            if (!email) {
                alert('Please provide an email');
                return;
            }

            userEmail = email;

            // Send transcript
            try {
                await fetch(`${API_BASE}/api/send-transcript`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email,
                        name,
                        transcript: chatHistory,
                        projects: selectedProjects.map(p => p.name),
                        hours
                    })
                });
            } catch (error) {
                console.error('Failed to send transcript:', error);
            }

            // Update summary
            document.getElementById('summary-name').textContent = name;
            document.getElementById('summary-projects').textContent = selectedProjects.map(p => p.name).join(', ');
            document.getElementById('summary-hours').textContent = `${hours} hrs/month`;

            showStage('schedule');
        }

        function showStage(stage) {
            ['initial', 'projects', 'commit', 'schedule', 'confirmed'].forEach(s => {
                document.getElementById(`stage-${s}`).classList.add('hidden');
            });
            document.getElementById(`stage-${stage}`).classList.remove('hidden');
        }

        // Fit score display
        function updateFitDisplay() {
            let display = document.getElementById('fit-score-display');
            if (!display) {
                display = document.createElement('div');
                display.id = 'fit-score-display';
                display.className = 'bg-slate-900 border border-slate-700 rounded-lg p-4 mb-4 text-center';
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.parentElement.insertBefore(display, messagesContainer);
            }
            display.innerHTML = `
                <p class="text-sm text-slate-500 mb-2">Fit Score</p>
                <p class="text-2xl font-bold text-emerald-400">${fitScore}/100</p>
                ${canUnlockEmail ? '<p class="text-xs text-emerald-400 mt-2">✓ Ready to continue</p>' : ''}
            `;
        }

        // Email gate
        function showEmailGate() {
            let gate = document.getElementById('email-gate-container');
            if (!gate) {
                gate = document.createElement('div');
                gate.id = 'email-gate-container';
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.parentElement.insertBefore(gate, messagesContainer);
            }
            gate.className = 'bg-slate-900 border border-blue-500/30 rounded-lg p-4 mb-4';
            gate.innerHTML = `
                <p class="text-sm text-blue-300 font-semibold mb-3">Ready to move forward?</p>
                <input type="email" id="gate-email" placeholder="your@email.com"
                    class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-sm mb-3 focus:outline-none focus:border-blue-500">
                <button onclick="submitEmail()" class="w-full bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg text-sm font-semibold">
                    Continue
                </button>
            `;
        }

        async function submitEmail() {
            const email = document.getElementById('gate-email').value.trim();
            if (!email) {
                alert('Please enter your email');
                return;
            }
            userEmail = email;
            document.getElementById('email-gate-container').remove();
            showStage('projects');
        }

        init();
    </script>
</body>
</html>
